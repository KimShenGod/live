name: Daily Download and Run

on:
  schedule:
    - cron: '0 9 * * *'  # UTC时间09:00，北京时间17:00
  workflow_dispatch:  # 允许手动触发

jobs:
  download-and-run:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许修改仓库内容（用于git push）

    steps:
    # 1. 检出当前仓库
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史，便于后续 rebase 操作

    # 2. 设置Python环境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. 下载指定仓库的特定文件（修复：正确的API路径 + 认证）
    - name: Download target file
      run: |
        # 修复：明确指定文件路径（假设目标文件名为 bbxx.m3u,位于仓库根目录)
        # 注意：替换为实际文件路径
        TARGET_FILE="bbxx.m3u"
        API_URL="https://api.github.com/repos/kimwang1978/collect-txt/contents/$TARGET_FILE"
        
        # 使用 curl 下载（添加认证头 + 正确文件路径 + 正确媒体类型）
        curl -L \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3.raw" \
          -o "$TARGET_FILE" \
          "$API_URL"
        
        # 验证文件是否下载成功（非空）
        if [ ! -s "$TARGET_FILE" ]; then
          echo "Error: Failed to download valid file! File is empty or download failed."
          cat "$TARGET_FILE"  # 打印文件内容便于调试
          exit 1
        fi
        echo "✅ File downloaded successfully: $TARGET_FILE (size: $(stat -c%s "$TARGET_FILE") bytes)"

    # 4. 安装FFmpeg
    - name: Install FFmpeg (for FFprobe)
      run: sudo apt-get update && sudo apt-get install -y ffmpeg

    # 5. 安装Python依赖
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    # 6. 运行Python脚本（修复：检查脚本是否存在）
    - name: Run Python script
      run: |
        # 检查脚本是否存在
        SCRIPT_PATH="${{ github.workspace }}/src/merged_m3u_processor.py"
        if [ ! -f "$SCRIPT_PATH" ]; then
          echo "Error: Script not found at $SCRIPT_PATH!"
          exit 1
        fi
        # 运行脚本
        python "$SCRIPT_PATH" bbxx.m3u -o bbxx_iptv.m3u -t 15 -d 15

    # 7. 提交文件到仓库（修复：闭合引号 + 检查修改）
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 1. 拉取远程最新更改（使用 rebase 避免多余的 merge commit）
        git pull --rebase origin main || {
          echo "Pull failed, trying to resolve conflicts..."
          # 2. 若 rebase 失败（冲突），则强制使用本地版本
          git rebase --abort
          git pull --no-rebase --force || true
        }
        
        # 3. 添加文件
        git add bbxx.m3u bbxx_iptv.m3u
        
        # 4. 仅当有修改时才提交
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Auto download file [$(date +'%Y-%m-%d %H:%M:%S')]"
          # 5. 推送（若 rebase 成功，则直接推送；否则可能需要强制推送）
          git push || git push --force-with-lease  # 使用 --force-with-lease 比 --force 更安全
        fi
      shell: /usr/bin/bash -e {0}