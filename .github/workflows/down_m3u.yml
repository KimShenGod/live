name: Daily Download and Run

on:
  schedule:
    - cron: '0 9 * * *'  # UTC时间09:00，北京时间17:00
  workflow_dispatch:  # 允许手动触发

jobs:
  download-and-run:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许修改仓库内容（用于git push）

    steps:
    # 1. 检出当前仓库
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史，便于后续 rebase 操作

    # 2. 设置Python环境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. 下载指定仓库的特定文件（修复：正确的API路径 + 认证）
    - name: Download target file
      run: |
        # 修复：明确指定文件路径（假设目标文件名为 bbxx.m3u,位于仓库根目录)
        # 注意：替换为实际文件路径
        TARGET_FILE="bbxx.m3u"
        API_URL="https://api.github.com/repos/kimwang1978/collect-txt/contents/$TARGET_FILE"
        
        # 使用 curl 下载（添加认证头 + 正确文件路径 + 正确媒体类型）
        curl -L \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3.raw" \
          -o "$TARGET_FILE" \
          "$API_URL"
        
        # 验证文件是否下载成功（非空）
        if [ ! -s "$TARGET_FILE" ]; then
          echo "Error: Failed to download valid file! File is empty or download failed."
          cat "$TARGET_FILE"  # 打印文件内容便于调试
          exit 1
        fi
        echo "✅ File downloaded successfully: $TARGET_FILE (size: $(stat -c%s "$TARGET_FILE") bytes)"

    # 4. 安装FFmpeg
    - name: Install FFmpeg (for FFprobe)
      run: sudo apt-get update && sudo apt-get install -y ffmpeg

    # 5. 安装Python依赖
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    # 6. 运行Python脚本（修复：检查脚本是否存在）
    - name: Run Python script
      run: |
        # 检查脚本是否存在
        SCRIPT_PATH="${{ github.workspace }}/src/merged_m3u_processor.py"
        if [ ! -f "$SCRIPT_PATH" ]; then
          echo "Error: Script not found at $SCRIPT_PATH!"
          exit 1
        fi
        # 运行脚本
        python "$SCRIPT_PATH" bbxx.m3u -o bbxx_iptv.m3u -t 15 -d 15

    # 7. 运行Python脚本（合成EPG文件）
    - name: Run Python script
      run: |
        # 检查脚本是否存在
        SCRIPT_PATH="${{ github.workspace }}/src/merge_epg_xml.py"
        if [ ! -f "$SCRIPT_PATH" ]; then
          echo "Error: Script not found at $SCRIPT_PATH!"
          exit 1
        fi
        # 运行脚本
        python "$SCRIPT_PATH"

    # 8. 运行Python脚本（修复：检查脚本是否存在）
    - name: Run channel merge script
      run: |
        # 检查脚本是否存在
        SCRIPT_PATH="${{ github.workspace }}/src/merge_channels.py"
        if [ ! -f "$SCRIPT_PATH" ]; then
          echo "Error: Script not found at $SCRIPT_PATH!"
          exit 1
        fi
        # 运行脚本
        python "$SCRIPT_PATH" bbxx_iptv.m3u
    # 9. 运行Python脚本（将m3u文件中的频道名改成epg中读取到的名字）
    - name: Run modify channel name script
      run: |
        # 检查脚本是否存在
        SCRIPT_PATH="${{ github.workspace }}/src/update_channel_names.py"
        if [ ! -f "$SCRIPT_PATH" ]; then
          echo "Error: Script not found at $SCRIPT_PATH!"
          exit 1
        fi
        # 运行脚本
        python "$SCRIPT_PATH" -a alias2.txt -i bbxx_lite.m3u -o bbxx_lite_new.m3u
    # 10. 提交文件到仓库（修复：闭合引号 + 检查修改）
    - name: Commit and push changes 
      run: | 
        git config --local user.email "action@github.com" 
        git config --local user.name "GitHub Action" 
        
        # 1. Stash any unstaged changes to clean the working directory
        git stash push -m "workflow-temp-stash" || true
        
        # 2. Pull with rebase to get latest changes
        git pull --rebase origin main || { 
          echo "Rebase failed, trying merge..." 
          git pull origin main || {
            echo "Merge also failed, aborting..."
            exit 1
          }
        }
        
        # 3. Apply the stash if there was one
        git stash pop || true
        
        # 4. Add only the specific files we modified
        git add bbxx.m3u bbxx_iptv.m3u  bbxx_lite.m3u merged_epg.xml
        
        # 5. Only commit if there are changes
        if git diff --staged --quiet; then 
          echo "No changes to commit." 
        else 
          git commit -m "Auto download file [$(date +'%Y-%m-%d %H:%M:%S')]" 
          # 6. Push changes safely
          git push origin HEAD:main || git push --force-with-lease origin HEAD:main 
        fi 
      shell: /usr/bin/bash -e {0}